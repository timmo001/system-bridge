name: Build and package application

on:
  push:
    branches:
      - master
    tags:
      - "*"
  pull_request:
    types:
      - opened
      - synchronize
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_type == 'tag' && format('tag-{0}', github.ref_name) || github.ref }}
  cancel-in-progress: ${{ github.ref_type != 'tag' }}

jobs:
  build:
    name: Build application
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: system-bridge-linux
            binary_ext: ""
          - os: windows-latest
            platform: windows
            artifact_name: system-bridge-windows
            binary_ext: ".exe"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up go
        uses: actions/setup-go@v5
        with:
          cache: true
          go-version-file: "go.mod"

      - name: Cache go build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-build-${{ hashFiles('**/go.mod', '**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-build-

      - name: Cache linux dependencies
        if: matrix.platform == 'linux'
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-cache-${{ hashFiles('.github/workflows/build-and-package-application.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-cache-

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libc6-dev libx11-dev libxtst-dev libxkbcommon-dev libxkbcommon-x11-dev xorg-dev libx11-xcb-dev

      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="5.0.0-dev+${{ github.sha }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Run tests
        run: go test -v ./...

      - name: Build application
        env:
          GOOS: ${{ matrix.platform }}
          GOARCH: amd64
          CGO_ENABLED: 1
        run: |
          go build -v -ldflags="-X 'github.com/timmo001/system-bridge/version.Version=${{ env.VERSION }}'" -o "system-bridge-${{ matrix.platform }}${{ matrix.binary_ext }}"

      - name: Cache windows sensor builds
        if: matrix.platform == 'windows'
        id: cache-sensors
        uses: actions/cache@v4
        with:
          path: lib/sensors/windows/bin
          key: ${{ runner.os }}-sensor-builds-${{ hashFiles('.scripts/windows/build-sensors.ps1', 'lib/sensors/windows/**/*.cs', 'lib/sensors/windows/**/*.csproj') }}-${{ env.VERSION }}
          restore-keys: |
            ${{ runner.os }}-sensor-builds-${{ hashFiles('.scripts/windows/build-sensors.ps1', 'lib/sensors/windows/**/*.cs', 'lib/sensors/windows/**/*.csproj') }}-
            ${{ runner.os }}-sensor-builds-

      - name: Build windows sensors
        if: matrix.platform == 'windows' && steps.cache-sensors.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          & "$PWD/.scripts/windows/build-sensors.ps1" -Version $env:VERSION

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.get_version.outputs.version }}
          path: |
            system-bridge-${{ matrix.platform }}${{ matrix.binary_ext }}
            lib/sensors/windows/bin
          retention-days: ${{ github.ref_type == 'tag' && 90 || 7 }}

  prepare-packaging:
    name: Prepare artifacts for packaging
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="5.0.0-dev+${{ github.sha }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download linux build artifact
        uses: actions/download-artifact@v4
        with:
          name: system-bridge-linux-${{ env.VERSION }}
          path: ${{ github.workspace }}

      - name: Download windows build artifact
        if: ${{ !env.ACT }}
        uses: actions/download-artifact@v4
        with:
          name: system-bridge-windows-${{ env.VERSION }}
          path: ${{ github.workspace }}

      - name: Upload artifacts for packaging
        uses: actions/upload-artifact@v4
        with:
          name: system-bridge-binaries-${{ env.VERSION }}
          path: |
            ${{ github.workspace }}/system-bridge-linux
            ${{ !env.ACT && github.workspace }}/system-bridge-windows.exe
            ${{ !env.ACT && github.workspace }}/lib/sensors/windows/bin
          retention-days: ${{ github.ref_type == 'tag' && 90 || 7 }}

  linux-package:
    name: Package for linux
    runs-on: ubuntu-latest
    needs: prepare-packaging
    if: ${{ !vars.ACT || vars.ACT_PLATFORM == 'ubuntu-latest' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="5.0.0-dev+${{ github.sha }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: system-bridge-binaries-${{ env.VERSION }}
          path: ${{ github.workspace }}

      - name: Setup executable
        run: |
          chmod +x ${{ github.workspace }}/system-bridge-linux
          mkdir -p ${{ github.workspace }}/dist

      - name: Install appimage tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

      - name: Install packaging dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg fakeroot rpm

      - name: Create appimage
        run: |
          chmod +x .scripts/linux/create-appimage.sh
          ./.scripts/linux/create-appimage.sh

      - name: Create deb package
        run: |
          chmod +x .scripts/linux/create-deb.sh
          ./.scripts/linux/create-deb.sh

      - name: Create rpm package
        run: |
          chmod +x .scripts/linux/create-rpm.sh
          ./.scripts/linux/create-rpm.sh

      - name: Prepare arch linux script
        run: |
          chmod +x .scripts/linux/create-arch.sh

      - name: Create arch linux package
        run: |
          docker run --rm -v ${{ github.workspace }}:/build archlinux:latest bash -c "
            pacman -Syu --noconfirm
            pacman -S --noconfirm base-devel sudo

            # Create a build user with sudo access
            useradd -m builduser
            echo 'builduser ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/builduser

            # Copy files to a location the build user can access
            mkdir -p /home/builduser/build
            cp -r /build/* /home/builduser/build/
            chown -R builduser:builduser /home/builduser/build

            # Run the build as the non-root user
            cd /home/builduser/build/.scripts/linux
            su builduser -c './create-arch.sh'

            # Copy results back to workspace
            mkdir -p /build/dist
            find /home/builduser/build -name '*.pkg.tar.zst' -exec cp {} /build/dist/ \;
            ls -la /build/dist/
          "

      - name: Upload linux packages
        uses: actions/upload-artifact@v4
        with:
          name: system-bridge-linux-packages-${{ env.VERSION }}
          path: dist/*
          retention-days: ${{ github.ref_type == 'tag' && 90 || 7 }}

  windows-package:
    name: Package for windows
    runs-on: windows-latest
    needs: prepare-packaging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="5.0.0-dev+${{ github.sha }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: system-bridge-binaries-${{ env.VERSION }}
          path: ${{ github.workspace }}

      - name: Create executable directory
        run: mkdir -p ${{ github.workspace }}/dist

      - name: Install nsis
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Create windows installer
        run: |
          ./.scripts/windows/create-installer.ps1

      - name: Upload windows installer
        uses: actions/upload-artifact@v4
        with:
          name: system-bridge-windows-installer-${{ env.VERSION }}
          path: dist/*.exe
          retention-days: ${{ github.ref_type == 'tag' && 90 || 7 }}

  create-release:
    name: Create release
    needs:
      - linux-package
      - windows-package
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download linux packages
        uses: actions/download-artifact@v4
        with:
          name: system-bridge-linux-packages-${{ github.ref_name }}
          path: dist/linux

      - name: Download windows installer
        uses: actions/download-artifact@v4
        with:
          name: system-bridge-windows-installer-${{ github.ref_name }}
          path: dist/windows

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/linux/*
            dist/windows/*
          draft: true
          prerelease: false
          generate_release_notes: true
